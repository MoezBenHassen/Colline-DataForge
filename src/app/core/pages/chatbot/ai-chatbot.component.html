<!-- The Floating Chat Bubble -->
<button
    pButton
    type="button"
    class="chat-bubble neon"
    [ngClass]="{'chat-bubble-open': isOpen}"
    (click)="toggleChat()"
    aria-label="Open chat"
>
    <!-- optional sparkle icon -->
    <span class="sparkle-icon" aria-hidden="true">âœ§</span>
    <span class="label">{{ isOpen ? 'Close' : 'Chat' }}</span>

    <!-- star particles -->
    <span class="stars">
        <i></i><i></i><i></i><i></i><i></i>
        <i></i><i></i><i></i><i></i><i></i>
        <i></i><i></i>
    </span>
</button>

@if (isOpen) {
    <div class="chat-window shadow-2xl" [ngClass]="{'maximized': isMaximized}">
        <!-- Header -->
        <div class="chat-header">
            <div class="chat-header-content">
                <div class="chat-header-text">
                    <div class="font-bold text-lg">DataForge Assistant</div>
                    <div class="text-sm text-color-secondary">Your AI-powered guide</div>
                </div>
                <div class="chat-header-actions">
                    <button
                        pButton
                        type="button"
                        [icon]="isMaximized ? 'pi pi-window-minimize' : 'pi pi-window-maximize'"
                        class="p-button-text p-button-rounded header-btn maximize-btn"
                        (click)="toggleMaximize()"
                        [pTooltip]="isMaximized ? 'Restore' : 'Maximize'"
                        tooltipPosition="bottom">
                    </button>
                    <button
                        pButton
                        type="button"
                        icon="pi pi-times"
                        class="p-button-text p-button-rounded header-btn close-btn"
                        (click)="closeChat()"
                        pTooltip="Close"
                        tooltipPosition="bottom">
                    </button>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div class="chat-messages" #scrollContainer>
            @for (message of messages; track trackById) {
                <div class="message" [ngClass]="'message-' + message.author">
                    <div class="message-content">
                        <markdown [data]="message.text"></markdown>
                    </div>
                </div>
            }

            <!-- Dedicated typing bubble, outside the loop -->
            @if (isLoading) {
                <div class="message message-ai">
                    <div class="message-content">
                        <div class="typing-indicator"><span></span><span></span><span></span></div>
                    </div>
                </div>
            }
        </div>

        <!-- Input -->
        <div class="chat-input">
            <input type="text" pInputText placeholder="Ask a question..." class="w-full"
                   [(ngModel)]="userInput"
                   (keyup.enter)="sendMessage()"
                   [disabled]="isLoading" />
            <p-button icon="pi pi-send" styleClass="p-button-primary p-button-text"
                      (click)="sendMessage()"
                      [disabled]="isLoading || !userInput.trim()"></p-button>
        </div>
    </div>
}
